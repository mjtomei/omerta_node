digraph {
    rankdir=TB;
    node [shape=box, style=rounded];
    edge [fontsize=10];

    __start__ [shape=point, width=0.2];
    __start__ -> IDLE;


    IDLE -> CHECKING_CHAIN_KNOWLEDGE [label="WITNESS_REQUEST"];
    CHECKING_CHAIN_KNOWLEDGE -> CHECKING_BALANCE [label="auto"];
    CHECKING_BALANCE -> CHECKING_EXISTING_LOCKS [label="auto\n[observed_balance >= amoun...]"];
    CHECKING_BALANCE -> SHARING_PRELIMINARY [label="auto\n[observed_balance < amount]"];
    CHECKING_EXISTING_LOCKS -> SHARING_PRELIMINARY [label="auto"];
    SHARING_PRELIMINARY -> COLLECTING_PRELIMINARIES [label="auto"];
    COLLECTING_PRELIMINARIES -> COLLECTING_PRELIMINARIES [label="WITNESS_PRELIMINARY"];
    COLLECTING_PRELIMINARIES -> VOTING [label="auto\n[LENGTH(preliminaries) >= ...]"];
    COLLECTING_PRELIMINARIES -> VOTING [label="timeout(PRELIMINARY_TIMEOUT)"];
    VOTING -> COLLECTING_VOTES [label="auto"];
    COLLECTING_VOTES -> COLLECTING_VOTES [label="WITNESS_FINAL_VOTE"];
    COLLECTING_VOTES -> BUILDING_RESULT [label="auto\n[LENGTH(votes) >= WITNESS_...]"];
    COLLECTING_VOTES -> BUILDING_RESULT [label="timeout(CONSENSUS_TIMEOUT)\n[LENGTH(votes) >= WITNESS_...]"];
    BUILDING_RESULT -> SIGNING_RESULT [label="auto"];
    SIGNING_RESULT -> PROPAGATING_RESULT [label="auto"];
    PROPAGATING_RESULT -> ESCROW_ACTIVE [label="CONSUMER_SIGNED_LOCK"];
    PROPAGATING_RESULT -> DONE [label="timeout(CONSENSUS_TIMEOUT)"];
    ESCROW_ACTIVE -> CHECKING_TOPUP_BALANCE [label="TOPUP_INTENT"];
    CHECKING_TOPUP_BALANCE -> VOTING_TOPUP [label="auto\n[topup_observed_balance - ...]"];
    CHECKING_TOPUP_BALANCE -> ESCROW_ACTIVE [label="auto\n[topup_observed_balance - ...]"];
    VOTING_TOPUP -> COLLECTING_TOPUP_VOTES [label="auto"];
    COLLECTING_TOPUP_VOTES -> COLLECTING_TOPUP_VOTES [label="TOPUP_VOTE"];
    COLLECTING_TOPUP_VOTES -> BUILDING_TOPUP_RESULT [label="auto\n[LENGTH(topup_votes) >= WI...]"];
    COLLECTING_TOPUP_VOTES -> BUILDING_TOPUP_RESULT [label="timeout(PRELIMINARY_TIMEOUT)\n[LENGTH(topup_votes) >= WI...]"];
    COLLECTING_TOPUP_VOTES -> ESCROW_ACTIVE [label="timeout(CONSENSUS_TIMEOUT)"];
    BUILDING_TOPUP_RESULT -> PROPAGATING_TOPUP [label="auto"];
    PROPAGATING_TOPUP -> ESCROW_ACTIVE [label="CONSUMER_SIGNED_TOPUP"];
    PROPAGATING_TOPUP -> ESCROW_ACTIVE [label="timeout(CONSENSUS_TIMEOUT)"];
    ESCROW_ACTIVE -> ESCROW_ACTIVE [label="LIVENESS_PING"];
}