stateDiagram-v2
    [*] --> IDLE
    FAILED --> [*]
    IDLE --> SENDING_LOCK_INTENT : initiate_lock\n[provider_chain_checkpoint != n...]
    SENDING_LOCK_INTENT --> WAITING_FOR_WITNESS_COMMITMENT : [auto]
    WAITING_FOR_WITNESS_COMMITMENT --> VERIFYING_PROVIDER_CHAIN : WITNESS_SELECTION_COMMITMENT
    WAITING_FOR_WITNESS_COMMITMENT --> FAILED : LOCK_REJECTED
    WAITING_FOR_WITNESS_COMMITMENT --> FAILED : timeout(WITNESS_COMMITMENT_TIMEOUT)
    VERIFYING_PROVIDER_CHAIN --> VERIFYING_WITNESSES : [auto]\n[chain_segment_valid_and_contai...]
    VERIFYING_WITNESSES --> SENDING_REQUESTS : [auto]\n[witness_selection_valid]
    SENDING_REQUESTS --> WAITING_FOR_RESULT : [auto]
    WAITING_FOR_RESULT --> REVIEWING_RESULT : LOCK_RESULT_FOR_SIGNATURE
    WAITING_FOR_RESULT --> FAILED : timeout(RECRUITMENT_TIMEOUT)
    REVIEWING_RESULT --> SIGNING_RESULT : [auto]\n[result_valid_and_accepted]
    REVIEWING_RESULT --> FAILED : [auto]\n[NOT result_valid_and_accepted]
    SIGNING_RESULT --> LOCKED : [auto]
    LOCKED --> LOCKED : LIVENESS_PING
    LOCKED --> SENDING_TOPUP : initiate_topup
    SENDING_TOPUP --> WAITING_FOR_TOPUP_RESULT : [auto]
    WAITING_FOR_TOPUP_RESULT --> REVIEWING_TOPUP_RESULT : TOPUP_RESULT_FOR_SIGNATURE
    WAITING_FOR_TOPUP_RESULT --> LOCKED : timeout(CONSENSUS_TIMEOUT)
    REVIEWING_TOPUP_RESULT --> SIGNING_TOPUP : [auto]\n[topup_result_valid]
    SIGNING_TOPUP --> LOCKED : [auto]