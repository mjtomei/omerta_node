stateDiagram-v2
    [*] --> IDLE
    IDLE --> CHECKING_CHAIN_KNOWLEDGE : WITNESS_REQUEST
    CHECKING_CHAIN_KNOWLEDGE --> CHECKING_BALANCE : [auto]
    CHECKING_BALANCE --> CHECKING_EXISTING_LOCKS : [auto]\n[observed_balance >= amount]
    CHECKING_BALANCE --> SHARING_PRELIMINARY : [auto]\n[observed_balance < amount]
    CHECKING_EXISTING_LOCKS --> SHARING_PRELIMINARY : [auto]
    SHARING_PRELIMINARY --> COLLECTING_PRELIMINARIES : [auto]
    COLLECTING_PRELIMINARIES --> COLLECTING_PRELIMINARIES : WITNESS_PRELIMINARY
    COLLECTING_PRELIMINARIES --> VOTING : [auto]\n[LENGTH(preliminaries) >= WITNE...]
    COLLECTING_PRELIMINARIES --> VOTING : timeout(PRELIMINARY_TIMEOUT)
    VOTING --> COLLECTING_VOTES : [auto]
    COLLECTING_VOTES --> COLLECTING_VOTES : WITNESS_FINAL_VOTE
    COLLECTING_VOTES --> BUILDING_RESULT : [auto]\n[LENGTH(votes) >= WITNESS_THRES...]
    COLLECTING_VOTES --> BUILDING_RESULT : timeout(CONSENSUS_TIMEOUT)\n[LENGTH(votes) >= WITNESS_THRES...]
    BUILDING_RESULT --> SIGNING_RESULT : [auto]
    SIGNING_RESULT --> PROPAGATING_RESULT : [auto]
    PROPAGATING_RESULT --> ESCROW_ACTIVE : CONSUMER_SIGNED_LOCK
    PROPAGATING_RESULT --> DONE : timeout(CONSENSUS_TIMEOUT)
    ESCROW_ACTIVE --> CHECKING_TOPUP_BALANCE : TOPUP_INTENT
    CHECKING_TOPUP_BALANCE --> VOTING_TOPUP : [auto]\n[topup_observed_balance - total...]
    CHECKING_TOPUP_BALANCE --> ESCROW_ACTIVE : [auto]\n[topup_observed_balance - total...]
    VOTING_TOPUP --> COLLECTING_TOPUP_VOTES : [auto]
    COLLECTING_TOPUP_VOTES --> COLLECTING_TOPUP_VOTES : TOPUP_VOTE
    COLLECTING_TOPUP_VOTES --> BUILDING_TOPUP_RESULT : [auto]\n[LENGTH(topup_votes) >= WITNESS...]
    COLLECTING_TOPUP_VOTES --> BUILDING_TOPUP_RESULT : timeout(PRELIMINARY_TIMEOUT)\n[LENGTH(topup_votes) >= WITNESS...]
    COLLECTING_TOPUP_VOTES --> ESCROW_ACTIVE : timeout(CONSENSUS_TIMEOUT)
    BUILDING_TOPUP_RESULT --> PROPAGATING_TOPUP : [auto]
    PROPAGATING_TOPUP --> ESCROW_ACTIVE : CONSUMER_SIGNED_TOPUP
    PROPAGATING_TOPUP --> ESCROW_ACTIVE : timeout(CONSENSUS_TIMEOUT)
    ESCROW_ACTIVE --> ESCROW_ACTIVE : LIVENESS_PING