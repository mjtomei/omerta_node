digraph {
    rankdir=TB;
    node [shape=box, style=rounded];
    edge [fontsize=10];

    __start__ [shape=point, width=0.2];
    __start__ -> IDLE;

    FAILED [shape=box, style="rounded,bold"];

    IDLE -> SENDING_LOCK_INTENT [label="initiate_lock\n[has_provider_checkpoint]"];
    SENDING_LOCK_INTENT -> WAITING_FOR_WITNESS_COMMITMENT [label="auto"];
    WAITING_FOR_WITNESS_COMMITMENT -> VERIFYING_PROVIDER_CHAIN [label="WITNESS_SELECTION_COMMITMENT"];
    WAITING_FOR_WITNESS_COMMITMENT -> FAILED [label="LOCK_REJECTED"];
    WAITING_FOR_WITNESS_COMMITMENT -> FAILED [label="timeout(WITNESS_COMMITMENT_TIMEOUT)"];
    VERIFYING_PROVIDER_CHAIN -> VERIFYING_WITNESSES [label="auto\n[chain_segment_valid_and_c...]"];
    VERIFYING_WITNESSES -> SENDING_REQUESTS [label="auto\n[witness_selection_valid]"];
    SENDING_REQUESTS -> WAITING_FOR_RESULT [label="auto"];
    WAITING_FOR_RESULT -> REVIEWING_RESULT [label="LOCK_RESULT_FOR_SIGNATURE"];
    WAITING_FOR_RESULT -> FAILED [label="timeout(RECRUITMENT_TIMEOUT)"];
    REVIEWING_RESULT -> SIGNING_RESULT [label="auto\n[result_valid_and_accepted]"];
    SIGNING_RESULT -> LOCKED [label="auto"];
    LOCKED -> LOCKED [label="LIVENESS_PING"];
    LOCKED -> SENDING_TOPUP [label="initiate_topup"];
    SENDING_TOPUP -> WAITING_FOR_TOPUP_RESULT [label="auto"];
    WAITING_FOR_TOPUP_RESULT -> REVIEWING_TOPUP_RESULT [label="TOPUP_RESULT_FOR_SIGNATURE"];
    WAITING_FOR_TOPUP_RESULT -> LOCKED [label="timeout(CONSENSUS_TIMEOUT)"];
    REVIEWING_TOPUP_RESULT -> SIGNING_TOPUP [label="auto\n[topup_result_valid]"];
    SIGNING_TOPUP -> LOCKED [label="auto"];
    FAILED -> IDLE [label="auto"];
}